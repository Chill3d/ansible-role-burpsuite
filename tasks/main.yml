---
# tasks file for ansible-role-burpsuite

- name: Install required packages
  apt:
    name: "{{ burpsuite_packages }}"
    state: present

- name: Remove Kali burpsuite package if installed
  apt:
    name: burpsuite
    state: absent

- name: Check if previously installed
  stat:
    path: "{{ burpsuite_dir }}/.install4j/i4jparams.conf"
  register: install4j_config_file

- name: Read install4j config file
  slurp:
    src: "{{ burpsuite_dir }}/.install4j/i4jparams.conf"
  register: install4j_config_contents
  when: install4j_config_file.stat.exists

- name: Get current version
  set_fact:
    installed_version: "{{ install4j_config_contents.content | b64decode |
        regex_search('applicationVersion=\"[0-9.]+\"', multiline=True) |
        regex_replace('applicationVersion=\"([0-9.]+)\"', '\\1') }}"
  when: install4j_config_file.stat.exists

- block:
    - name: Set facts for Burp Suite
      set_fact:
        burpsuite_installer_script: "burpsuite_{{ burpsuite_product_type }}_linux_{{ burpsuite_version | regex_replace('\.', '_')}}.sh"

    - name: Download Burp Suite Community
      get_url:
        url: "{{ burpsuite_community_download_url }}"
        dest: "{{ burpsuite_installer_dir }}/{{ burpsuite_installer_script }}"
        mode: "0440"
      when:
        - burpsuite_community_download_enabled
        - burpsuite_product_type == 'community'

    - name: Get file checksum
      stat:
        path: "{{ burpsuite_installer_dir }}/{{ burpsuite_installer_script }}"
        checksum: sha256
      register: installer_script

    - name: Assert that checksum is correct
      assert:
        that:
          - burpsuite_installer_checksum == installer_script.stat.checksum
        fail_msg: "Burp Suite installer checksum is invalid"
        success_msg: "Burp Suite installer checksum is valid"

    - name: Create response.varfile for unattended install
      template:
        src: burpsuite_response.varfile.j2
        dest: "{{ burpsuite_installer_dir }}/burpsuite_response.varfile"

    - name: Install Burp Suite
      command: "/bin/sh {{ burpsuite_installer_script }} -q -varfile burpsuite_response.varfile -overwrite"
      args:
        chdir: "{{ burpsuite_installer_dir }}"
    
    - name: Remove Burp Suite Community installer
      file:
        path: "{{ burpsuite_installer_dir }}/{{ burpsuite_installer_script }}"
        state: absent
      when: burpsuite_community_download_enabled

    - name: Remove response.varfile 
      file:
        path: "{{ burpsuite_installer_dir }}/burpsuite_response.varfile"
        state: absent
  when: installed_version is not defined or installed_version != burpsuite_version

- name: Create directory for Burp Suite extras
  file:
    path: "{{ burpsuite_extras_dir }}"
    state: directory
    mode: 0755

- name: Download JRuby for Burp Suite
  get_url:
    url: "{{ burpsuite_jruby_jar_url }}"
    dest: "{{ burpsuite_extras_dir }}/jruby-complete.jar"
    checksum: "sha1:{{ burpsuite_jruby_jar_checksum }}"

- name: Download Jython for Burp Suite
  get_url:
    url: "{{ burpsuite_jython_jar_url }}"
    dest: "{{ burpsuite_extras_dir }}/jython-standalone.jar"
    checksum: "sha1:{{ burpsuite_jython_jar_checksum }}"

- name: Copy license_burp.py script to extras directory
  copy:
    src: license_burp.py
    dest: "{{ burpsuite_extras_dir }}/license_burp.py"
    mode: 0644

- name: Accept Burp Suite agreement/license
  command: "python3 license_burp.py --license '{{ burpsuite_license_path }}' {{ burpsuite_product_type }} {{ burpsuite_dir }}"
  args:
    chdir: "{{ burpsuite_extras_dir }}"
  register: license_burp
  changed_when: "'Terms and conditions accepted.' in license_burp.stdout or
    'License successfully installed and activated.' in license_burp.stdout"

- name: Copy download_ca_cert.py script to extras directory
  copy:
    src: download_ca_cert.py
    dest: "{{ burpsuite_extras_dir }}/download_ca_cert.py"
    mode: 0644

- name: Download Burp Suite CA certificate
  command: "python3 download_ca_cert.py {{ burpsuite_product_type }} {{ burpsuite_dir }} {{ burpsuite_cacert_path }}"
  args:
    chdir: "{{ burpsuite_extras_dir }}"
  register: download_ca_cert
  changed_when: "'CA Certificate updated' in download_ca_cert.stdout or
    'CA Certificate saved.' in download_ca_cert.stdout"
